# Feature Branch Jobs
# Build, test, and validate NSO packages before merging to main

# Build: Compile NSO package
package-compilation:
  stage: build
  extends: .base_job
  timeout: 15 minutes
  script:
    - 'echo "Package: $PACKAGE | Commit: $CI_COMMIT_SHORT_SHA"'
    - sshpass -p "$NSO_DEV_PWD" scp $SSH_OPTS -r nso_cicd/packages/$PACKAGE $NSO_DEV_USER@$NSO_DEV_IP:/home/developer/$PACKAGE
    - |
      sshpass -p "$NSO_DEV_PWD" ssh $SSH_OPTS $NSO_DEV_USER@$NSO_DEV_IP "
        set -e && cd /home/developer/ &&
        cp -r $PACKAGE $NSO_RUN_PATH/packages/ &&
        source $NSO_RC_PATH &&
        cd $NSO_RUN_PATH/packages/$PACKAGE/src &&
        make clean && make &&
        cd $NSO_RUN_PATH/packages &&
        tar -czf /home/developer/nso-package_$PACKAGE.tar.gz $PACKAGE
      "
    - echo "Downloading compiled package tarball from dev server..."
    - sshpass -p "$NSO_DEV_PWD" scp $SSH_OPTS $NSO_DEV_USER@$NSO_DEV_IP:/home/developer/nso-package_$PACKAGE.tar.gz .
    - echo "Verifying tarball was downloaded..."
    - ls -lh nso-package_$PACKAGE.tar.gz
    - test -f nso-package_$PACKAGE.tar.gz || (echo "ERROR Tarball not downloaded!" && exit 1)
    - echo "âœ… Tarball ready for artifact upload"
  artifacts:
    paths:
      - nso-package_$PACKAGE.tar.gz
    expire_in: 1 week
  retry:
    max: 2
    when: script_failure

# Build: Reload package in dev NSO
package-load:
  stage: build
  extends: .base_job
  dependencies: [package-compilation]
  script:
    - sshpass -p "$NSO_DEV_PWD" ssh $SSH_OPTS $NSO_DEV_USER@$NSO_DEV_IP "source $NSO_RC_PATH && echo 'packages reload' | ncs_cli -Cu admin"

# Test: Validate loopback service
test-loopback-service:
  stage: test
  extends: .base_job
  timeout: 20 minutes
  dependencies: [package-load]
  script:
    - cd nso_cicd/tests/loopback-test
    - python loopback-test.py --nso_url "http://$NSO_DEV_IP:8080" --device "dev-core-rtr01" --username "$NSO_DEV_USER" --password "$NSO_DEV_PWD" 2>&1 | tee test-xr.log
    - python loopback-test.py --nso_url "http://$NSO_DEV_IP:8080" --device "dev-dist-rtr01" --username "$NSO_DEV_USER" --password "$NSO_DEV_PWD" 2>&1 | tee test-ios.log
  after_script:
    - cd nso_cicd/tests/loopback-test && ls -lh *.log 2>/dev/null || echo "No log files generated"
  artifacts:
    when: always
    paths: [nso_cicd/tests/loopback-test/*.log]
    expire_in: 30 days
  retry:
    max: 1
    when: script_failure

# Cleanup dev environment after testing
cleanup-dev-environment:
  stage: .post
  extends: .base_job
  timeout: 5 minutes
  allow_failure: true
  when: always
  script:
    - |
      sshpass -p "$NSO_DEV_PWD" ssh $SSH_OPTS $NSO_DEV_USER@$NSO_DEV_IP "
        rm -rf /home/developer/$PACKAGE /home/developer/nso-package_$PACKAGE.tar.gz $NSO_RUN_PATH/packages/$PACKAGE &&
        source $NSO_RC_PATH && echo 'packages reload force' | ncs_cli -Cu admin
      " || echo "Cleanup had issues (non-fatal)"
