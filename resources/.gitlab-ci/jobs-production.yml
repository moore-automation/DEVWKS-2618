# Production Jobs
# Deliver and deploy pre-tested packages to production

# Deliver: Retrieve pre-tested artifact for production
prepare-production-artifact:
  stage: deliver
  extends: .base_job
  variables:
    GITLAB_API_URL: "http://devtools-gitlab.lab.devnetsandbox.local/api/v4"
  script:
    - echo "ðŸ“¦ Downloading pre-tested artifact from develop branch..."
    - curl -f -L -H "JOB-TOKEN:$CI_JOB_TOKEN" -o artifacts.zip "$GITLAB_API_URL/projects/$CI_PROJECT_ID/jobs/artifacts/develop/download?job=package-compilation"
    - unzip -q artifacts.zip && rm artifacts.zip
    - ls -lh nso-package_$PACKAGE.tar.gz
    - echo "âœ… Artifact ready for deployment"
  artifacts:
    paths: [nso-package_$PACKAGE.tar.gz]
    expire_in: 1 week

# Deploy: Production deployment (manual approval required)
deploy-to-production:
  stage: deploy_prod
  when: manual
  extends: .base_job
  timeout: 15 minutes
  dependencies: [prepare-production-artifact]
  resource_group: production-nso
  environment:
    name: production
  script:
    - sshpass -p "$NSO_PROD_PWD" scp $SSH_OPTS nso-package_$PACKAGE.tar.gz $NSO_DEV_USER@$NSO_PROD_IP:/home/developer/
    - |
      sshpass -p "$NSO_PROD_PWD" ssh $SSH_OPTS $NSO_DEV_USER@$NSO_PROD_IP "
        set -e && cd /home/developer/ &&
        tar -xzf nso-package_$PACKAGE.tar.gz &&
        [ -d \"$NSO_RUN_PATH/packages/loopback\" ] && mv $NSO_RUN_PATH/packages/loopback $NSO_RUN_PATH/packages/loopback.backup.\$(date +%Y%m%d_%H%M%S) || true &&
        cp -r $PACKAGE $NSO_RUN_PATH/packages/loopback &&
        source $NSO_RC_PATH &&
        echo 'packages reload' | ncs_cli -Cu admin &&
        echo 'show packages package $PACKAGE oper-status' | ncs_cli -Cu admin &&
        rm -f nso-package_$PACKAGE.tar.gz
      "

# Post-deployment verification
verify-production-deployment:
  stage: .post
  extends: .base_job
  when: on_success
  needs: [deploy-to-production]
  script:
    - |
      sshpass -p "$NSO_PROD_PWD" ssh $SSH_OPTS $NSO_DEV_USER@$NSO_PROD_IP "
        source $NSO_RC_PATH &&
        echo 'show packages package $PACKAGE oper-status' | ncs_cli -Cu admin | grep -q 'up' &&
        echo 'âœ… Package operational in production'
      "

# Rollback capability (optional, manual trigger)
rollback-production:
  stage: .post
  when: manual
  extends: .base_job
  environment:
    name: production
  script:
    - |
      sshpass -p "$NSO_PROD_PWD" ssh $SSH_OPTS $NSO_DEV_USER@$NSO_PROD_IP "
        set -e &&
        BACKUP=\$(ls -t $NSO_RUN_PATH/packages/loopback.backup.* 2>/dev/null | head -n1) &&
        if [ -z \"\$BACKUP\" ]; then
          echo 'ERROR: No backup found for rollback'
          exit 1
        fi &&
        echo \"Rolling back to: \$BACKUP\" &&
        rm -rf $NSO_RUN_PATH/packages/loopback &&
        mv \$BACKUP $NSO_RUN_PATH/packages/loopback &&
        source $NSO_RC_PATH &&
        echo 'packages reload' | ncs_cli -Cu admin &&
        echo 'âœ… Rollback completed'
      "
